<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Viewer</title>
    <style>
        :root {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --grid-gap: 10px;
            --grid-item-bg: #2a2a2a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            color: var(--text-color);
        }
        
        .select-button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 2rem;
            transition: background-color 0.2s;
        }

        .select-button:hover {
            background-color: var(--primary-hover-color);
        }

        #file-input {
            display: none;
        }

        #media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--grid-gap);
        }

        .grid-item {
            position: relative;
            width: 100%;
            padding-top: 100%;
            cursor: pointer;
            background-color: var(--grid-item-bg);
            border-radius: 5px;
            overflow: hidden;
        }

        .grid-item img,
        .grid-item video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #lightbox.visible {
            display: flex;
        }

        #lightbox-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #lightbox-content img,
        #lightbox-content video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
            margin: auto;
        }

        #lightbox-content:fullscreen {
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #lightbox-content:fullscreen img,
        #lightbox-content:fullscreen video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .close-button, .fullscreen-button {
            position: absolute;
            color: #f1f1f1;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
            z-index: 1001;
        }

        .close-button {
            top: 15px;
            right: 35px;
            font-size: 40px;
        }
        
        .fullscreen-button {
            top: 15px;
            right: 90px;
            font-size: 30px;
        }

        .close-button:hover, .fullscreen-button:hover {
            color: #bbb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vanilla JS Media Viewer</h1>
        <button id="select-folder-button" class="select-button">Select Media Folder</button>
        <input type="file" id="file-input" webkitdirectory directory multiple>
        <div id="media-grid"></div>
    </div>

    <div id="lightbox">
        <span class="close-button" id="close-lightbox">&times;</span>
        <button class="fullscreen-button" id="fullscreen-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3m-18 0V19a2 2 0 0 0 2 2h3"></path></svg>
        </button>
        <div id="lightbox-content"></div>
    </div>

    <script>
        const selectFolderButton = document.getElementById('select-folder-button');
        const fileInput = document.getElementById('file-input');
        const mediaGrid = document.getElementById('media-grid');
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.getElementById('lightbox-content');
        const closeLightboxButton = document.getElementById('close-lightbox');
        const fullscreenButton = document.getElementById('fullscreen-button');
        const originalTitle = document.title;

        let mediaFiles = [];
        let currentIndex = 0;
        let intersectionObserver;
        const supportedImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
        const supportedVideoTypes = ['video/mp4', 'video/webm', 'video/ogg'];

        selectFolderButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelection);
        mediaGrid.addEventListener('click', handleGridClick);
        closeLightboxButton.addEventListener('click', closeLightbox);
        fullscreenButton.addEventListener('click', toggleFullscreen);
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });
        document.addEventListener('keydown', handleKeyPress);
        document.addEventListener('fullscreenchange', handleFullscreenChange);

        function setupIntersectionObserver() {
            if (intersectionObserver) {
                intersectionObserver.disconnect();
            }
            const options = {
                rootMargin: '0px 0px 200px 0px'
            };
            intersectionObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const gridItem = entry.target;
                        const index = parseInt(gridItem.dataset.index, 10);
                        loadMediaForGridItem(gridItem, index);
                        observer.unobserve(gridItem);
                    }
                });
            }, options);
        }

        function loadMediaForGridItem(gridItem, index) {
            const file = mediaFiles[index];
            const url = URL.createObjectURL(file);

            let mediaElement;
            if (supportedImageTypes.includes(file.type)) {
                mediaElement = document.createElement('img');
            } else {
                mediaElement = document.createElement('video');
                mediaElement.muted = true;
                mediaElement.preload = 'metadata';
                mediaElement.addEventListener('loadedmetadata', () => {
                    mediaElement.currentTime = 0;
                }, { once: true });
            }
            mediaElement.src = url;
            gridItem.appendChild(mediaElement);
        }

        function handleFileSelection(event) {
            mediaGrid.innerHTML = '';
            mediaFiles = [];
            const files = Array.from(event.target.files);

            files.forEach(file => {
                if (supportedImageTypes.includes(file.type) || supportedVideoTypes.includes(file.type)) {
                    mediaFiles.push(file);
                }
            });

            mediaFiles.sort((a, b) => a.name.localeCompare(b.name));
            
            setupIntersectionObserver();

            mediaFiles.forEach((file, index) => {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.dataset.index = index;
                mediaGrid.appendChild(gridItem);
                intersectionObserver.observe(gridItem);
            });
        }

        function handleGridClick(event) {
            const gridItem = event.target.closest('.grid-item');
            if (gridItem) {
                currentIndex = parseInt(gridItem.dataset.index, 10);
                showInLightbox(currentIndex);
            }
        }

        function showInLightbox(index) {
            if (index < 0 || index >= mediaFiles.length) return;

            lightboxContent.innerHTML = '';
            const file = mediaFiles[index];
            document.title = file.name;
            const url = URL.createObjectURL(file);

            let mediaElement;
            if (supportedImageTypes.includes(file.type)) {
                mediaElement = document.createElement('img');
            } else {
                mediaElement = document.createElement('video');
                mediaElement.controls = true;
                mediaElement.autoplay = true;
                mediaElement.loop = true;
            }
            mediaElement.src = url;
            mediaElement.alt = file.name;

            lightboxContent.appendChild(mediaElement);
            if (!lightbox.classList.contains('visible')) {
                lightbox.classList.add('visible');
            }
        }

        function closeLightbox() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            lightbox.classList.remove('visible');
            lightboxContent.innerHTML = '';
            document.title = originalTitle;
        }

        function showNextMedia() {
            const currentVideo = lightboxContent.querySelector('video');
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.currentTime = 0;
            }

            currentIndex = (currentIndex + 1) % mediaFiles.length;
            showInLightbox(currentIndex);
        }

        function showPreviousMedia() {
            const currentVideo = lightboxContent.querySelector('video');
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.currentTime = 0;
            }

            currentIndex = (currentIndex - 1 + mediaFiles.length) % mediaFiles.length;
            showInLightbox(currentIndex);
        }

        function handleKeyPress(event) {
            if (!lightbox.classList.contains('visible')) return;

            if (event.key === 'ArrowRight') {
                showNextMedia();
            } else if (event.key === 'ArrowLeft') {
                showPreviousMedia();
            } else if (event.key === 'Escape') {
                if (!document.fullscreenElement) {
                     closeLightbox();
                }
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                if (lightboxContent.requestFullscreen) {
                    lightboxContent.requestFullscreen();
                } else if (lightboxContent.webkitRequestFullscreen) {
                    lightboxContent.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }

        function handleFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement;
            fullscreenButton.style.display = isFullscreen ? 'none' : '';
            closeLightboxButton.style.display = isFullscreen ? 'none' : '';
        }
    </script>
</body>
</html>
